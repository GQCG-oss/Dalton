#!/usr/bin/env python

import sys

last_commit_rev    = 'unknown'
last_commit_author = 'unknown'
last_commit_time   = 'unknown'

if sys.version >= '2.4':
    import re
    import string
    import subprocess
    import os
    
  # p = subprocess.Popen('cd @CMAKE_SOURCE_DIR@; git show', shell=True, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    p = subprocess.Popen('cd @CMAKE_SOURCE_DIR@; git show', shell=True, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    stdout, stderr = p.communicate()
    git_revision_info_file='@CMAKE_SOURCE_DIR@/lsutil/git_revision_info.f90'
    if stderr:
        if (os.path.isfile(git_revision_info_file) and os.path.getsize(git_revision_info_file) > 0):
            # this is not a git repo but @CMAKE_SOURCE_DIR@/gp/git_revision_info.F90
            # exists - then this is a release or an exported source code
            # in this case do not regenerate the file but exit
            sys.exit('not regenerating lsutil/git_revision_info.f90...\n')
        else: # file does not exist, or is of zero size - generate it with 'unknown' parameters
            last_commit_rev = 'unknown'
            last_commit_author = 'unknown'
            last_commit_time = 'unknown'
    else:
        last_commit_rev    = string.replace(stdout.splitlines()[0], 'commit ', '')
        last_commit_author = string.replace(re.sub(r'<.*>', '', stdout.splitlines()[1]), 'Author: ', '')
        last_commit_time   = string.replace(stdout.splitlines()[2], 'Date:   ', '')

print 'module gitrevinfo'
print 'contains'
print 'subroutine print_git_revision_info(lupri)'
print 'implicit none'
print 'integer,intent(in) :: lupri'
print "    write(lupri, '(a)') '                    '" 
print "    write(lupri, '(a)') '  Revision info     '" 
print "    write(lupri, '(a)') '--------------------'" 
print "    write(lupri, '(a)') '                    '" 

def print_line(l, r):
    print "    write(lupri, '(a)') ' %s | %s'" % (l.ljust(24), r)

print_line('Last commit rev',    last_commit_rev)
print_line('Last commit author', last_commit_author)
print_line('Last commit time',   last_commit_time)

print 'end subroutine'
print 'end module gitrevinfo'
