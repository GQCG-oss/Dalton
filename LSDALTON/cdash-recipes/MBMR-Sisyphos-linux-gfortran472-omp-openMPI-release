TMP_DIR=/home/sisyphos/NightlyTesting/tmp/DaltonGfortranReleaseOPENMPIMBMR
SCRATCH_DIR=/tmp/sisyphos/DaltonGfortranReleaseOPENMPIMBMR
rm -rf $TMP_DIR
rm -rf $SCRATCH_DIR

git clone --recursive git@gitlab.com:dalton/dalton.git $TMP_DIR
cd $TMP_DIR
export OMP_NUM_THREADS=2
export DALTON_TMPDIR=$SCRATCH_DIR
export DALTON_NUM_MPI_PROCS=3
export CTEST_PROJECT_NAME=LSDALTON
export LSDALTON_LAUNCHER="mpirun -np 3 -mca btl ^openib"
#module load mpi/openmpi-$(uname -i)
#the module load do not seem to work when called from a crontab script, so instead we do
export PATH=/usr/lib64/openmpi/bin:$PATH
export LD_LIBRARY_PATH=/usr/lib64/openmpi/lib:$LD_LIBRARY_PATH
#atlas will be found per default anyway but good to have. 
#mkl will not be found since it is not sourced (source mklvars.sh) 
export MATH_ROOT=/lib64/atlas


./setup --fc=mpif90 --cc=mpicc --cxx=mpic++ --omp --mpi --timing -DENABLE_DEC=ON -DENABLE_TENSORS=ON -D BUILDNAME="MBMR-Sisyphos-linux-gfortran472-omp-openMPI-release" build

cd build
make release
#this creates a tar file named DALTON-Source.tar.gz
if [[ -e  DALTON-Source.tar.gz ]]; then
 tar -zxvf DALTON-Source.tar.gz
 cd DALTON-Source

 ./setup --fc=mpif90 --cc=mpicc --cxx=mpic++ --omp --mpi --timing -DENABLE_DEC=ON -DENABLE_TENSORS=ON -D BUILDNAME="MBMR-Sisyphos-linux-gfortran472-omp-openMPI-release" build
 cd build
 ctest -D Nightly --track NightlyMakeRelease -L linsca
fi
exit 0
