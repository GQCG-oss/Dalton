#!/bin/bash

# radovan: script to remove sources from final tarball

# this is to figure out the location of this script
# http://stackoverflow.com/questions/59895/can-a-bash-script-tell-what-directory-its-stored-in
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
    SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
    SOURCE="$(readlink "$SOURCE")"
    # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
    [[ $SOURCE != /* ]] && SOURCE="$SCRIPT_DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

WORKING_DIRECTORY=$1
if [ "$WORKING_DIRECTORY" = "" ]; then
    echo "usage: $0 /path/to/be/filtered"
    exit 1
fi

delete_flags=`cat $SCRIPT_DIR/delete_flags`

for file in `find $WORKING_DIRECTORY -type f -name "*.f"`   \
            `find $WORKING_DIRECTORY -type f -name "*.F"`   \
            `find $WORKING_DIRECTORY -type f -name "*.f90"` \
            `find $WORKING_DIRECTORY -type f -name "*.F90"` \
            `find $WORKING_DIRECTORY -type f -name "*.c"`
do
    $SCRIPT_DIR/cppp.py $delete_flags $file
done

# radovan: sadly not portable
# TEMP_FILE=`mktemp`
TEMP_FILE="deleteme"

if [ -f $SCRIPT_DIR/paths_to_exclude ]
then
    for file in `cat $SCRIPT_DIR/paths_to_exclude`; do
        # file can be file or directory that's why we use -rf
        rm -rf $WORKING_DIRECTORY/$file
        for list_of_sources in cmake/SourcesDALTON.cmake; do
            # no in-place sed, not generally available on mac
            sed "\,$file,d" $WORKING_DIRECTORY/$list_of_sources > $TEMP_FILE
            mv $TEMP_FILE $WORKING_DIRECTORY/$list_of_sources
        done
    done
else
    echo ERROR: file paths_to_exclude not found!
fi
