
#######################################################################
#  TEST DESCRIPTION
#######################################################################
#
#*# geoopt_delintmin
#*# ----------------
#*# Molecule:         C6H5CHO
#*# Wave Function:    SCF
#*# Test Purpose:     Minimization in delocalized internal coordinates.
#*#                   A model Hessian is determined initially, then updated using
#*#                   the DFP-formula. Baker's convergence criteria are used.
#
#######################################################################
#  MOLECULE INPUT
#######################################################################
cat > geoopt_delintmin.mol <<%EOF%
BASIS                                                                           
STO-3G
First order minimization in delocalized internal coordinates
(test73)
    3    1Z                                                                     
        8.    1                                                                 
O     6.1169594363        0.0000000000        0.0000000000             *
        6.    7                                                                 
C    -0.4281183799       -2.2595362151        0.0000000000             *
C    -2.9286935224       -1.4347871225        0.0000000000             *
C    -3.4656164013        1.1411808224        0.0000000000             *
C    -1.5061149145        2.8972276388        0.0000000000             *
C     0.9961412279        2.0785184368        0.0000000000             *
C     1.5529020669       -0.5103443405        0.0000000000             *
C     4.3100239391       -1.4696981757        0.0000000000             *
        1.    6                                                                 
H     4.6927731310       -3.5243404323        0.0000000000             *
H    -0.0483891239       -4.2673340819        0.0000000000             *
H    -4.4516781974       -2.7942683921        0.0000000000             *
H    -5.4051670195        1.7780840801        0.0000000000             *
H    -1.9265366341        4.8949599174        0.0000000000             *
H     2.4915143918        3.4703378645        0.0000000000             *
%EOF%

#######################################################################
#  DALTON INPUT
#######################################################################
cat > geoopt_delintmin.dal <<%EOF%
**GENERAL
.OPTIMIZE
*OPTIMIZE
.DELINT
.DFP
.BAKER
**WAVE FUNCTION
.HF
*END OF INPUT
%EOF%
#######################################################################



#######################################################################

#######################################################################
#  CHECK SCRIPT
#######################################################################
echo '#!/bin/ksh
log=$1

if [ `uname` = IRIX64 ]; then
   GREP="egrep"
else
   GREP="egrep -a"
fi

# Geometry optimization
CRIT1=`$GREP "1st order method with DFP update will be used\." $log | wc -l`
CRIT2=`$GREP "Optimization will be performed in delocalized internal coordinates\." $log | wc -l`
CRIT3=`$GREP "Model Hessian will be used as initial Hessian\." $log | wc -l`
CRIT4=`$GREP "Baker.s convergence criteria will be used\." $log | wc -l`
TEST[1]=`expr	$CRIT1 \+ $CRIT2 \+ $CRIT3 \+ $CRIT4`
CTRL[1]=4
ERROR[1]="GEOMETRY OPTIMIZATION NOT SET UP CORRECTLY"

# Geometry
CRIT1=`$GREP "1 * O * x * 6\.1169594363" $log | wc -l`
CRIT2=`$GREP "4 * C * x * \-0\.4281183799" $log | wc -l`
CRIT3=`$GREP "5 * y * \-2\.2595362151" $log | wc -l`
CRIT4=`$GREP "7 * C * x * \-2\.9286935224" $log | wc -l`
CRIT5=`$GREP "8 * y * \-1\.4347871225" $log | wc -l`
CRIT6=`$GREP "10 * C * x * \-3\.4656164013" $log | wc -l`
CRIT7=`$GREP "11 * y * 1\.1411808224" $log | wc -l`
CRIT8=`$GREP "13 * C * x * \-1\.5061149145" $log | wc -l`
CRIT9=`$GREP "14 * y * 2\.8972276388" $log | wc -l`
CRIT10=`$GREP "16 * C * x * 0\.9961412279" $log | wc -l`
CRIT11=`$GREP "17 * y * 2\.0785184368" $log | wc -l`
CRIT12=`$GREP "19 * C * x * 1\.5529020669" $log | wc -l`
CRIT13=`$GREP "20 * y * \-0\.5103443405" $log | wc -l`
CRIT14=`$GREP "22 * C * x * 4\.3100239391" $log | wc -l`
CRIT15=`$GREP "23 * y * \-1\.4696981757" $log | wc -l`
CRIT16=`$GREP "25 * H * x * 4\.6927731310" $log | wc -l`
CRIT17=`$GREP "26 * y * \-3\.5243404323" $log | wc -l`
CRIT18=`$GREP "28 * H * x * \-0\.0483891239" $log | wc -l`
CRIT19=`$GREP "29 * y * \-4\.2673340819" $log | wc -l`
CRIT20=`$GREP "31 * H * x * \-4\.4516781974" $log | wc -l`
CRIT21=`$GREP "32 * y * \-2\.7942683921" $log | wc -l`
CRIT22=`$GREP "34 * H * x * \-5\.4051670195" $log | wc -l`
CRIT23=`$GREP "35 * y * 1\.7780840801" $log | wc -l`
CRIT24=`$GREP "37 * H * x * \-1\.9265366341" $log | wc -l`
CRIT25=`$GREP "38 * y * 4\.8949599174" $log | wc -l`
CRIT26=`$GREP "40 * H * x * 2\.4915143918" $log | wc -l`
CRIT27=`$GREP "41 * y * 3\.4703378645" $log | wc -l`
TEST[2]=`expr	$CRIT1 \+ $CRIT2 \+ $CRIT3 \+ $CRIT4 \+ $CRIT5 \+ $CRIT6 \+ \
		$CRIT7 \+ $CRIT8 \+ $CRIT9 \+ $CRIT10 \+ $CRIT11 \+ $CRIT12 \+ \
		$CRIT13 \+ $CRIT14 \+ $CRIT15 \+ $CRIT16 \+ $CRIT17 \+ $CRIT18 \+ \
		$CRIT19 \+ $CRIT20 \+ $CRIT21 \+ $CRIT22 \+ $CRIT23 \+ $CRIT24 \+ \
		$CRIT25 \+ $CRIT26 \+ $CRIT27`
CTRL[2]=27
ERROR[2]="GEOMETRY NOT READ CORRECTLY"

# Symmetry
CRIT1=`$GREP "Number of coordinates in each symmetry\: * 28 14" $log | wc -l`
CRIT2=`$GREP "Number of orbitals in each symmetry\: * 38 * 8" $log | wc -l`
TEST[3]=`expr	$CRIT1 \+ $CRIT2`
CTRL[3]=2
ERROR[3]="SYMMETRY NOT CORRECT"

# Initial energy
CRIT1=`$GREP "Final * HF energy\: * \-339\.11787646992[0-9]" $log | wc -l`
TEST[4]=`expr	$CRIT1`
CTRL[4]=1
ERROR[4]="INITIAL ENERGY NOT CORRECT"

# Initial gradient
CRIT1=`$GREP "C * y * \-0\.010726009[0-9]" $log | wc -l`
CRIT2=`$GREP "C * x * \-0\.008899013[0-9]" $log | wc -l`
CRIT3=`$GREP "C * y * \-0\.006274485[0-9]" $log | wc -l`
CRIT4=`$GREP "C * x * \-0\.007739336[0-9]" $log | wc -l`
CRIT5=`$GREP "C * y * 0\.003485292[0-9]" $log | wc -l`
CRIT6=`$GREP "C * x * \-0\.004568647[0-9]" $log | wc -l`
CRIT7=`$GREP "C * y * 0\.011628853[0-9]" $log | wc -l`
CRIT8=`$GREP "C * x * 0\.008232389[0-9]" $log | wc -l`
CRIT9=`$GREP "C * y * 0\.005583114[0-9]" $log | wc -l`
CRIT10=`$GREP "C * x * \-0\.008371141[0-9]" $log | wc -l`
CRIT11=`$GREP "C * y * 0\.014393619[0-9]" $log | wc -l`
CRIT12=`$GREP "C * x * \-0\.011686740[0-9]" $log | wc -l`
CRIT13=`$GREP "C * y * \-0\.031174392[0-9]" $log | wc -l`
CRIT14=`$GREP "H * x * 0\.013400777[0-9]" $log | wc -l`
CRIT15=`$GREP "H * y * \-0\.000507136[0-9]" $log | wc -l`
CRIT16=`$GREP "H * x * \-0\.003238607[0-9]" $log | wc -l`
CRIT17=`$GREP "H * y * 0\.001156374[0-9]" $log | wc -l`
CRIT18=`$GREP "H * x * 0\.001431557[0-9]" $log | wc -l`
CRIT19=`$GREP "H * y * 0\.001561477[0-9]" $log | wc -l`
CRIT20=`$GREP "H * x * 0\.002459469[0-9]" $log | wc -l`
CRIT21=`$GREP "H * y * \-0\.000748965[0-9]" $log | wc -l`
CRIT22=`$GREP "H * x * \-0\.000030208[0-9]" $log | wc -l`
CRIT23=`$GREP "H * y * \-0\.002110412[0-9]" $log | wc -l`
CRIT24=`$GREP "H * x * \-0\.004706241[0-9]" $log | wc -l`
CRIT25=`$GREP "H * y * 0\.001641256[0-9]" $log | wc -l`
TEST[5]=`expr	$CRIT1 \+ $CRIT2 \+ $CRIT3 \+ $CRIT4 \+ $CRIT5 \+ $CRIT6 \+ \
		$CRIT7 \+ $CRIT8 \+ $CRIT9 \+ $CRIT10 \+ $CRIT11 \+ $CRIT12 \+ \
		$CRIT13 \+ $CRIT14 \+ $CRIT15 \+ $CRIT16 \+ $CRIT17 \+ $CRIT18 \+ \
		$CRIT19 \+ $CRIT20 \+ $CRIT21 \+ $CRIT22 \+ $CRIT23 \+ $CRIT24 \+ \
		$CRIT25`
CTRL[5]=25
ERROR[5]="INITIAL GRADIENT NOT CORRECT"

# Initial step
CRIT1=`$GREP "O * 6\.091447206[0-9] * 0\.035608673[0-9] * 0\.0000000000" $log | wc -l`
CRIT2=`$GREP "C * \-0\.424147786[0-9] * \-2\.261673562[0-9] * 0\.0000000000" $log | wc -l`
CRIT3=`$GREP "C * \-2\.911884220[0-9] * \-1\.440355383[0-9] * 0\.0000000000" $log | wc -l`
CRIT4=`$GREP "C * \-3\.441428562[0-9] * 1\.127279287[0-9] * 0\.0000000000" $log | wc -l`
CRIT5=`$GREP "C * \-1\.481078553[0-9] * 2\.871008812[0-9] * 0\.0000000000" $log | wc -l`
CRIT6=`$GREP "C * 1\.006362130[0-9] * 2\.051982098[0-9] * 0\.0000000000" $log | wc -l`
CRIT7=`$GREP "C * 1\.546954008[0-9] * \-0\.520467212[0-9] * 0\.0000000000" $log | wc -l`
CRIT8=`$GREP "C * 4\.276713311[0-9] * \-1\.392249605[0-9] * 0\.0000000000" $log | wc -l`
CRIT9=`$GREP "H * 4\.535502694[0-9] * \-3\.460579875[0-9] * 0\.0000000000" $log | wc -l`
CRIT10=`$GREP "H * \-0\.018408841[0-9] * \-4\.268073631[0-9] * 0\.0000000000" $log | wc -l`
CRIT11=`$GREP "H * \-4\.438557233[0-9] * \-2\.802197044[0-9] * 0\.0000000000" $log | wc -l`
CRIT12=`$GREP "H * \-5\.384206742[0-9] * 1\.771043336[0-9] * 0\.0000000000" $log | wc -l`
CRIT13=`$GREP "H * \-1\.892975737[0-9] * 4\.874854358[0-9] * 0\.0000000000" $log | wc -l`
CRIT14=`$GREP "H * 2\.535708328[0-9] * 3\.413819749[0-9] * 0\.0000000000" $log | wc -l`
TEST[6]=`expr	$CRIT1 \+ $CRIT2 \+ $CRIT3 \+ $CRIT4 \+ $CRIT5 \+ $CRIT6 \+ \
		$CRIT7 \+ $CRIT8 \+ $CRIT9 \+ $CRIT10 \+ $CRIT11 \+ $CRIT12 \+ \
		$CRIT13 \+ $CRIT14`
CTRL[6]=14
ERROR[6]="INITIAL STEP NOT CORRECT"

# Second iteration
CRIT1=`$GREP "Energy at this geometry is * \: * \-339\.12074[0-9]" $log | wc -l`
CRIT2=`$GREP "Norm of gradient * \: * 0\.00815[0-9]" $log | wc -l`
CRIT3=`$GREP "Norm of step * \: * 0\.06885[0-9]" $log | wc -l`
TEST[7]=`expr	$CRIT1 \+ $CRIT2 \+ $CRIT3`
CTRL[7]=3
ERROR[7]="SECOND ITERATION NOT CORRECT"

# Third iteration
CRIT1=`$GREP "Energy at this geometry is * \: * \-339\.12083[0-9]" $log | wc -l`
CRIT2=`$GREP "Norm of gradient * \: * 0\.00216[0-9]" $log | wc -l`
CRIT3=`$GREP "Norm of step * \: * 0\.01007[0-9]" $log | wc -l`
TEST[8]=`expr	$CRIT1 \+ $CRIT2 \+ $CRIT3`
CTRL[8]=3
ERROR[8]="THRID ITERATION NOT CORRECT"

# Fourth iteration
CRIT1=`$GREP "Norm of gradient * \: * 0\.00056[0-9]" $log | wc -l`
CRIT2=`$GREP "Norm of step * \: * 0\.00259[0-9]" $log | wc -l`
TEST[9]=`expr	$CRIT1 \+ $CRIT2`
CTRL[9]=2
ERROR[9]="FOURTH ITERATION NOT CORRECT"

# Final geometry
CRIT1=`$GREP "O * 6\.092086042[0-9] * 0\.015740279[0-9] * 0\.0000000000" $log | wc -l`
CRIT2=`$GREP "C * \-0\.413656164[0-9] * \-2\.254757303[0-9] * 0\.0000000000" $log | wc -l`
CRIT3=`$GREP "C * \-2\.901817588[0-9] * \-1\.440482004[0-9] * 0\.0000000000" $log | wc -l`
CRIT4=`$GREP "C * \-3\.438921358[0-9] * 1\.125902985[0-9] * 0\.0000000000" $log | wc -l`
CRIT5=`$GREP "C * \-1\.486678906[0-9] * 2\.878483897[0-9] * 0\.0000000000" $log | wc -l`
CRIT6=`$GREP "C * 0\.999738833[0-9] * 2\.063160638[0-9] * 0\.0000000000" $log | wc -l`
CRIT7=`$GREP "C * 1\.552256239[0-9] * \-0\.509445204[0-9] * 0\.0000000000" $log | wc -l`
CRIT8=`$GREP "C * 4\.269894188[0-9] * \-1\.398201953[0-9] * 0\.0000000000" $log | wc -l`
CRIT9=`$GREP "H * 4\.492935689[0-9] * \-3\.471513307[0-9] * 0\.0000000000" $log | wc -l`
CRIT10=`$GREP "H * 0\.010956750[0-9] * \-4\.257396504[0-9] * 0\.0000000000" $log | wc -l`
CRIT11=`$GREP "H * \-4\.425168500[0-9] * \-2\.805738713[0-9] * 0\.0000000000" $log | wc -l`
CRIT12=`$GREP "H * \-5\.384004323[0-9] * 1\.762457243[0-9] * 0\.0000000000" $log | wc -l`
CRIT13=`$GREP "H * \-1\.908218270[0-9] * 4\.880304164[0-9] * 0\.0000000000" $log | wc -l`
CRIT14=`$GREP "H * 2\.540597367[0-9] * 3\.411485781[0-9] * 0\.0000000000" $log | wc -l`
TEST[10]=`expr	$CRIT1 \+ $CRIT2 \+ $CRIT3 \+ $CRIT4 \+ $CRIT5 \+ $CRIT6 \+ \
		$CRIT7 \+ $CRIT8 \+ $CRIT9 \+ $CRIT10 \+ $CRIT11 \+ $CRIT12 \+ \
		$CRIT13 \+ $CRIT14`
CTRL[10]=56
ERROR[10]="FINAL GEOMETRY NOT CORRECT"

# Geometry convergence
CRIT1=`$GREP "Geometry converged in * 5 iterations\!" $log | wc -l`
CRIT2=`$GREP "Energy at final geometry is * \: * \-339\.12084[0-9] a\.u\." $log | wc -l`
CRIT3=`$GREP "Energy change during optimization \: * \-0\.00296[0-9] a\.u\." $log | wc -l`
TEST[11]=`expr	$CRIT1 \+ $CRIT2 \+ $CRIT3`
CTRL[11]=3
ERROR[11]="GEOMETRY OPTIMIZATION NOT CONVERGED"

PASSED=1
for i in 1 2 3 4 5 6 7 8 9 10 11
do
   if [ ${TEST[i]} -ne ${CTRL[i]} ]; then
     echo ${ERROR[i]}
     PASSED=0
   fi
done

if [ $PASSED -eq 1 ]
then
  echo TEST ENDED PROPERLY
  exit 0
else
  echo THERE IS A PROBLEM
  exit 1
fi

' > geoopt_delintmin.check
#######################################################################
